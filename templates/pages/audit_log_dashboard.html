{% extends 'base.html' %}

{% block title %}Audit Trail - Dreambook Salon{% endblock %}

{% block content %}
<div class="container-custom py-12">
  <!-- Header -->
  <div class="mb-12">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
      <div>
        <h1 class="text-4xl font-bold text-gradient mb-2">Audit Trail</h1>
        <p class="text-light-muted">Monitor all system actions and user activities in real-time</p>
      </div>
      <a href="{% url 'audit_log:export' %}{% if search_query %}?search={{ search_query }}{% endif %}{% if selected_user_id %}&user_id={{ selected_user_id }}{% endif %}{% if selected_date_from %}&date_from={{ selected_date_from }}{% endif %}{% if selected_date_to %}&date_to={{ selected_date_to }}{% endif %}{% for action_type in selected_action_types %}&action_types={{ action_type }}{% endfor %}" class="btn btn-primary">
        ‚¨áÔ∏è Export CSV
      </a>
    </div>
  </div>

  <!-- Filters Section with Better UX -->
  <div class="card p-8 mb-10 bg-gradient-to-br from-light-surface to-light-elevated border border-primary-500/10">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 rounded-lg bg-primary-500/10 flex items-center justify-center">
        <span class="text-xl">üîç</span>
      </div>
      <h2 class="text-xl font-bold text-light-text">Search & Filter</h2>
    </div>

    <form method="get" class="space-y-6">
      <!-- Search Bar -->
      <div class="relative">
        <input type="text" name="search" class="input w-full pl-12 py-3" placeholder="Search by description, email, or action..." value="{{ search_query }}">
        <svg class="absolute left-4 top-3.5 w-5 h-5 text-light-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>

      <!-- Filter Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- User Filter -->
        <div>
          <label class="block text-sm font-semibold text-light-text mb-2">üë§ User</label>
          <select name="user_id" class="input w-full">
            <option value="">All Users</option>
            {% for user in users %}
              <option value="{{ user.id }}" {% if user.id|stringformat:"s" == selected_user_id %}selected{% endif %}>
                {{ user.first_name|default:user.email }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Date From -->
        <div>
          <label class="block text-sm font-semibold text-light-text mb-2">üìÖ From Date</label>
          <input type="date" name="date_from" class="input w-full" value="{{ selected_date_from }}">
        </div>

        <!-- Date To -->
        <div>
          <label class="block text-sm font-semibold text-light-text mb-2">üìÖ To Date</label>
          <input type="date" name="date_to" class="input w-full" value="{{ selected_date_to }}">
        </div>

        <!-- Action Types Filter -->
        <div>
          <label class="block text-sm font-semibold text-light-text mb-2">‚ö° Action Type</label>
          <select name="action_types" multiple class="input w-full h-32">
            {% for value, label in action_types %}
              <option value="{{ value }}" {% if value in selected_action_types %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
          <p class="text-xs text-light-muted mt-1">Hold Ctrl/Cmd for multiple</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-3 pt-2">
        <button type="submit" class="btn btn-primary flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
          Apply Filters
        </button>
        <a href="{% url 'audit_log:dashboard' %}" class="btn btn-ghost">Reset All</a>
      </div>
    </form>
  </div>

  <!-- Audit Logs Timeline/Cards -->
  <div class="space-y-4">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 rounded-lg bg-primary-500/10 flex items-center justify-center">
        <span class="text-xl">üìã</span>
      </div>
      <h2 class="text-xl font-bold text-light-text">Activity Timeline</h2>
      {% if audit_logs %}
        <span class="ml-auto badge badge-info">{{ paginator.count }} total</span>
      {% endif %}
    </div>

    {% if audit_logs %}
      <div class="space-y-3">
        {% for log in audit_logs %}
          <div class="card p-5 border-l-4 {% if log.action_type == 'USER_CREATE' or log.action_type|slice:":6" == 'CREATE' %}border-l-emerald-500 bg-emerald-500/5{% elif log.action_type == 'USER_UPDATE' or log.action_type|slice:":6" == 'UPDATE' %}border-l-blue-500 bg-blue-500/5{% elif log.action_type == 'USER_DELETE' or log.action_type|slice:":6" == 'DELETE' %}border-l-red-500 bg-red-500/5{% elif log.action_type|slice:":7" == 'STATUS_' %}border-l-purple-500 bg-purple-500/5{% else %}border-l-primary-500 bg-primary-500/5{% endif %} hover:shadow-lg transition-all">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-2">
              <!-- Left: Action Badge & User -->
              <div class="flex items-center gap-3 flex-1">
                <div class="flex-shrink-0 w-10 h-10 rounded-lg {% if log.action_type == 'USER_CREATE' or log.action_type|slice:":6" == 'CREATE' %}bg-emerald-100{% elif log.action_type == 'USER_UPDATE' or log.action_type|slice:":6" == 'UPDATE' %}bg-blue-100{% elif log.action_type == 'USER_DELETE' or log.action_type|slice:":6" == 'DELETE' %}bg-red-100{% elif log.action_type|slice:":7" == 'STATUS_' %}bg-purple-100{% else %}bg-primary-100{% endif %} flex items-center justify-center text-lg">
                  {% if log.action_type == 'USER_CREATE' or log.action_type|slice:":6" == 'CREATE' %}‚ú®
                  {% elif log.action_type == 'USER_UPDATE' or log.action_type|slice:":6" == 'UPDATE' %}‚úèÔ∏è
                  {% elif log.action_type == 'USER_DELETE' or log.action_type|slice:":6" == 'DELETE' %}üóëÔ∏è
                  {% elif log.action_type|slice:":7" == 'STATUS_' %}‚ö°
                  {% else %}üìå
                  {% endif %}
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex px-3 py-1 rounded-full text-xs font-bold
                      {% if log.action_type == 'USER_CREATE' or log.action_type|slice:":6" == 'CREATE' %}bg-emerald-100 text-emerald-700
                      {% elif log.action_type == 'USER_UPDATE' or log.action_type|slice:":6" == 'UPDATE' %}bg-blue-100 text-blue-700
                      {% elif log.action_type == 'USER_DELETE' or log.action_type|slice:":6" == 'DELETE' %}bg-red-100 text-red-700
                      {% elif log.action_type|slice:":7" == 'STATUS_' %}bg-purple-100 text-purple-700
                      {% else %}bg-gray-100 text-gray-700
                      {% endif %}">
                      {{ log.get_action_type_display }}
                    </span>
                    <span class="text-sm font-semibold text-light-text">{{ log.user.first_name|default:log.user.email }}</span>
                    <span class="text-xs text-light-muted">{{ log.user.email }}</span>
                  </div>
                  <p class="text-sm text-light-text mt-1">{{ log.description }}</p>
                </div>
              </div>

              <!-- Right: Time & Target -->
              <div class="flex flex-col items-end gap-1 md:text-right">
                <span class="text-xs font-mono text-light-muted">{{ log.timestamp|date:"M d, Y ¬∑ H:i" }}</span>
                {% if log.content_type %}
                  <span class="text-xs text-light-muted">{{ log.content_type.name }} #{{ log.object_id }}</span>
                {% endif %}
              </div>
            </div>

            <!-- Additional Info -->
            <div class="flex flex-wrap gap-4 text-xs border-t border-light-border pt-3 mt-3">
              {% if log.ip_address %}
                <div class="flex items-center gap-2">
                  <span class="text-light-muted">üåê</span>
                  <span class="font-mono text-light-text">{{ log.ip_address }}</span>
                </div>
              {% endif %}
              {% if log.changes %}
                <div class="flex items-center gap-2">
                  <span class="text-light-muted">üìù</span>
                  <span class="text-light-text">{{ log.changes|length }} change{{ log.changes|pluralize }}</span>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination with Better Style -->
      {% if is_paginated %}
        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4">
          <div class="flex gap-2">
            {% if page_obj.has_previous %}
              <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                 class="btn btn-ghost text-sm">‚èÆ First</a>
              <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                 class="btn btn-ghost text-sm">‚Üê Previous</a>
            {% endif %}
          </div>

          <span class="badge badge-info">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>

          <div class="flex gap-2">
            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                 class="btn btn-ghost text-sm">Next ‚Üí</a>
              <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                 class="btn btn-ghost text-sm">Last ‚è≠</a>
            {% endif %}
          </div>
        </div>
      {% endif %}

    {% else %}
      <div class="card p-12 text-center border-2 border-dashed border-light-border">
        <div class="text-6xl mb-4">üì≠</div>
        <h3 class="text-2xl font-bold text-light-text mb-2">No activity found</h3>
        <p class="text-light-muted mb-6">No audit logs match your current filters. Try adjusting your search criteria.</p>
        <a href="{% url 'audit_log:dashboard' %}" class="btn btn-primary">Clear Filters & Try Again</a>
      </div>
    {% endif %}
  </div>
</div>

<style>
  /* Smooth transitions for cards */
  .card {
    transition: all 0.3s ease;
  }

  .card:hover {
    transform: translateY(-2px);
  }

  /* Search icon styling */
  input[type="text"]::placeholder {
    color: #8b8b8b;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add smooth scroll behavior
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth' });
      }
    });
  });

  // Highlight newly loaded pages
  const params = new URLSearchParams(window.location.search);
  if (params.has('page')) {
    const delay = setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  }
});
</script>
{% endblock %}
