{% extends 'base.html' %}

{% block title %}Audit Trail - Dreambook Salon{% endblock %}

{% block content %}
<div class="container-custom py-12">
  <!-- Header -->
  <div class="mb-10 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div>
      <h1 class="text-4xl font-bold text-gradient mb-2">Audit Trail</h1>
      <p class="text-light-muted">Easy-to-read history of what changed, who did it, and when.</p>
    </div>
    <a href="{% url 'audit_log:export' %}{% if search_query %}?search={{ search_query }}{% endif %}{% if selected_user_id %}&user_id={{ selected_user_id }}{% endif %}{% if selected_date_from %}&date_from={{ selected_date_from }}{% endif %}{% if selected_date_to %}&date_to={{ selected_date_to }}{% endif %}{% for action_type in selected_action_types %}&action_types={{ action_type }}{% endfor %}" class="btn btn-primary">
      Export CSV
    </a>
  </div>

  <!-- Filters -->
  <div class="card p-8 mb-10">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-10 h-10 rounded-lg bg-primary-500/10 flex items-center justify-center text-primary-600 font-bold">ðŸ”Ž</div>
      <h2 class="text-xl font-bold text-light-text">Search & Filter</h2>
    </div>
    <form method="get" class="space-y-6">
      <div class="relative">
        <input type="text" name="search" class="input w-full pl-12 py-3" placeholder="Search by description, email, or action..." value="{{ search_query }}">
        <svg class="absolute left-4 top-3.5 w-5 h-5 text-light-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-semibold text-light-text mb-2">User</label>
          <select name="user_id" class="input w-full">
            <option value="">All Users</option>
            {% for user in users %}
              <option value="{{ user.id }}" {% if user.id|stringformat:"s" == selected_user_id %}selected{% endif %}>{{ user.first_name|default:user.email }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-light-text mb-2">From Date</label>
          <input type="date" name="date_from" class="input w-full" value="{{ selected_date_from }}">
        </div>

        <div>
          <label class="block text-sm font-semibold text-light-text mb-2">To Date</label>
          <input type="date" name="date_to" class="input w-full" value="{{ selected_date_to }}">
        </div>

        <div>
          <label class="block text-sm font-semibold text-light-text mb-2">Action Type</label>
          <select name="action_types" multiple class="input w-full h-32">
            {% for value, label in action_types %}
              <option value="{{ value }}" {% if value in selected_action_types %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <p class="text-xs text-light-muted mt-1">Hold Ctrl/Cmd for multiple</p>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 pt-2">
        <button type="submit" class="btn btn-primary flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
          Apply Filters
        </button>
        <a href="{% url 'audit_log:dashboard' %}" class="btn btn-ghost">Reset All</a>
      </div>
    </form>
  </div>

  <!-- Timeline -->
  <div class="space-y-4">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-10 h-10 rounded-lg bg-primary-500/10 flex items-center justify-center text-primary-600 font-bold">ðŸ“œ</div>
      <h2 class="text-xl font-bold text-light-text">Activity Timeline</h2>
      {% if audit_logs %}
        <span class="ml-auto badge badge-info">{{ paginator.count }} total</span>
      {% endif %}
    </div>

    {% if audit_logs %}
      <div class="space-y-3">
        {% for log in audit_logs %}
          <div class="card p-5 border-l-4 {% if log.action_type == 'USER_CREATE' or log.action_type|slice:':6' == 'CREATE' %}border-l-emerald-500 bg-emerald-500/5{% elif log.action_type == 'USER_UPDATE' or log.action_type|slice:':6' == 'UPDATE' %}border-l-blue-500 bg-blue-500/5{% elif log.action_type == 'USER_DELETE' or log.action_type|slice:':6' == 'DELETE' %}border-l-red-500 bg-red-500/5{% elif log.action_type|slice:':7' == 'STATUS_' %}border-l-purple-500 bg-purple-500/5{% else %}border-l-primary-500 bg-primary-500/5{% endif %}">
            <div class="flex flex-col md:flex-row md:items-start justify-between gap-3 mb-2">
              <div class="flex items-start gap-3 flex-1">
                <div class="flex-shrink-0 w-24 text-sm font-semibold text-primary-700 bg-white border border-light-border rounded-lg px-3 py-2 text-center">
                  {{ log.get_action_type_display|default:"Action" }}
                </div>
                <div class="flex-1 space-y-1">
                  <div class="flex flex-wrap items-center gap-2">
                    {% with actor_name=log.actor_name|default:log.user.get_full_name|default:log.user.email %}
                      <span class="text-sm font-semibold text-light-text">By {{ actor_name }}</span>
                    {% endwith %}
                    <span class="text-xs text-light-muted">{{ log.actor_email|default:log.user.email }}</span>
                    {% if log.actor_role %}
                      <span class="badge badge-ghost text-[0.65rem]">{{ log.actor_role }}</span>
                    {% endif %}
                    {% if log.source %}
                      <span class="badge badge-ghost text-[0.65rem]">{{ log.source|title }}</span>
                    {% endif %}
                  </div>
                  <p class="text-sm text-light-text">{{ log.description|default:"Action recorded" }}</p>
                  <div class="flex flex-wrap items-center gap-2 text-xs font-mono text-light-muted">
                    {% if log.request_method %}
                      <span class="badge badge-ghost uppercase">{{ log.request_method }}</span>
                    {% endif %}
                    {% if log.request_path %}
                      <span class="text-light-muted break-all">{{ log.request_path }}</span>
                    {% endif %}
                    {% if log.status_code %}
                      <span class="badge badge-info">HTTP {{ log.status_code }}</span>
                    {% endif %}
                    {% if log.route_name %}
                      <span class="text-light-muted">Route: {{ log.route_name }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="flex flex-col items-end gap-1 md:text-right">
                <span class="text-xs font-mono text-light-muted">{{ log.timestamp|date:"M d, Y h:i A" }}</span>
                {% if log.target_repr or log.content_type %}
                  <span class="text-xs text-light-muted">
                    Target: {{ log.target_repr|default:log.content_type.name }}{% if log.object_id %} #{{ log.object_id }}{% endif %}
                  </span>
                {% endif %}
              </div>
            </div>
            <div class="flex flex-wrap gap-4 text-xs border-t border-light-border pt-3 mt-3">
              {% if log.ip_address %}
                <div class="flex items-center gap-2">
                  <span class="text-light-muted">IP:</span>
                  <span class="font-mono text-light-text">{{ log.ip_address }}</span>
                </div>
              {% endif %}
              {% if log.metadata and log.metadata.request_id %}
                <div class="flex items-center gap-2">
                  <span class="text-light-muted">Request ID:</span>
                  <span class="font-mono text-light-text">{{ log.metadata.request_id }}</span>
                </div>
              {% endif %}
              {% if log.changes %}
                <div class="flex items-center gap-2">
                  <span class="text-light-muted">Changes:</span>
                  <span class="text-light-text">{{ log.changes|length }} field{{ log.changes|pluralize }} updated</span>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      {% if is_paginated %}
        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4">
          <div class="flex gap-2">
            {% if page_obj.has_previous %}
              <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-ghost text-sm">First</a>
              <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-ghost text-sm">Previous</a>
            {% endif %}
          </div>

          <span class="badge badge-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

          <div class="flex gap-2">
            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-ghost text-sm">Next</a>
              <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-ghost text-sm">Last</a>
            {% endif %}
          </div>
        </div>
      {% endif %}

    {% else %}
      <div class="card p-12 text-center border-2 border-dashed border-light-border">
        <div class="text-4xl mb-4">ðŸ™‚</div>
        <h3 class="text-2xl font-bold text-light-text mb-2">No activity found</h3>
        <p class="text-light-muted mb-6">No audit logs match your current filters. Try adjusting your search criteria.</p>
        <a href="{% url 'audit_log:dashboard' %}" class="btn btn-primary">Clear Filters & Try Again</a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
