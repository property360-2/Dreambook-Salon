{% extends 'base.html' %}

{% block title %}Appointment Details · Dreambook Salon{% endblock title %}

{% block content %}
  <section class="page-appointment-detail">
    <header class="page-appointment-detail__header">
      <h1>Appointment Details</h1>
      <div class="page-appointment-detail__badges">
        {% include 'components/atoms/badge.html' with label=appointment.get_status_display style='primary' %}
        {% include 'components/atoms/badge.html' with label=appointment.get_payment_state_display style='secondary' %}
      </div>
    </header>

    <div class="page-appointment-detail__content">
      <div class="page-appointment-detail__main">
        <h2>{{ appointment.service.name }}</h2>

        <div class="page-appointment-detail__info">
          <div class="page-appointment-detail__info-item">
            <strong>Customer:</strong> {{ appointment.customer.get_full_name|default:appointment.customer.email }}
          </div>
          <div class="page-appointment-detail__info-item">
            <strong>Date & Time:</strong> {{ appointment.start_at|date:"F d, Y g:i A" }}
          </div>
          <div class="page-appointment-detail__info-item">
            <strong>End Time:</strong> {{ appointment.end_at|date:"g:i A" }}
          </div>
          <div class="page-appointment-detail__info-item">
            <strong>Duration:</strong> {{ appointment.service.duration_minutes }} minutes
          </div>
          <div class="page-appointment-detail__info-item">
            <strong>Price:</strong> ₱{{ appointment.service.price }}
          </div>
          <div class="page-appointment-detail__info-item">
            <strong>Status:</strong> {{ appointment.get_status_display }}
          </div>
          <div class="page-appointment-detail__info-item">
            <strong>Payment Status:</strong> {{ appointment.get_payment_state_display }}
          </div>
        </div>

        {% if appointment.notes %}
          <div class="page-appointment-detail__notes">
            <h3>Notes</h3>
            <p>{{ appointment.notes }}</p>
          </div>
        {% endif %}

        <div class="page-appointment-detail__service-info">
          <h3>Service Information</h3>
          <p>{{ appointment.service.description|default:"No description available." }}</p>
        </div>
      </div>

      <aside class="page-appointment-detail__actions">
        {% if user.role == 'CUSTOMER' and appointment.customer == user %}
          {% if appointment.status not in 'COMPLETED,NO_SHOW,CANCELLED' %}
            <form method="post" action="{% url 'appointments:cancel' appointment.id %}">
              {% csrf_token %}
              {% include 'components/atoms/button.html' with label='Cancel Appointment' style='danger' type='submit' %}
            </form>
          {% endif %}

          {% if appointment.payment_state == 'UNPAID' %}
            <a href="{% url 'payments:initiate' appointment.id %}" class="atom-button atom-button--primary">
              Make Payment
            </a>
          {% endif %}
        {% endif %}

        {% if user.role in 'STAFF,ADMIN' %}
          {% if appointment.status == 'IN_PROGRESS' %}
            <form method="post" action="{% url 'appointments:complete' appointment.id %}">
              {% csrf_token %}
              {% include 'components/atoms/button.html' with label='Mark as Completed' style='success' type='submit' %}
            </form>
          {% endif %}

          <div class="page-appointment-detail__status-update">
            <h4>Update Status</h4>
            <form method="post" action="{% url 'appointments:update_status' appointment.id %}">
              {% csrf_token %}
              <select name="status" class="atom-input">
                <option value="PENDING" {% if appointment.status == 'PENDING' %}selected{% endif %}>Pending</option>
                <option value="CONFIRMED" {% if appointment.status == 'CONFIRMED' %}selected{% endif %}>Confirmed</option>
                <option value="IN_PROGRESS" {% if appointment.status == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                <option value="COMPLETED" {% if appointment.status == 'COMPLETED' %}selected{% endif %}>Completed</option>
                <option value="NO_SHOW" {% if appointment.status == 'NO_SHOW' %}selected{% endif %}>No Show</option>
                <option value="CANCELLED" {% if appointment.status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
              </select>
              {% include 'components/atoms/button.html' with label='Update Status' style='primary' type='submit' %}
            </form>
          </div>
        {% endif %}

        <a href="{% if user.role == 'CUSTOMER' %}{% url 'appointments:my_appointments' %}{% else %}{% url 'appointments:staff_list' %}{% endif %}" class="atom-button atom-button--ghost">
          ← Back to Appointments
        </a>
      </aside>
    </div>
  </section>
{% endblock content %}
