{% extends 'base.html' %}

{% block title %}Analytics Dashboard ¬∑ Dreambook Salon{% endblock title %}

{% block content %}
  <div class="container-custom py-12">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-12 gap-4">
      <div>
        <h1 class="text-4xl font-bold text-gradient mb-2">Analytics Dashboard</h1>
        <p class="text-light-muted">Business insights and performance metrics</p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <a href="{% url 'analytics:business_intelligence' %}" class="btn btn-primary text-sm">
          <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
          </svg>
          Business Intelligence
        </a>
        <a href="{% url 'analytics:revenue' %}" class="btn btn-ghost text-sm">Revenue</a>
        <a href="{% url 'analytics:services' %}" class="btn btn-ghost text-sm">Services</a>
        <a href="{% url 'analytics:inventory' %}" class="btn btn-ghost text-sm">Inventory</a>
      </div>
    </div>

    <!-- Revenue Overview -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold text-light-text mb-6">Revenue Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="stat-card">
          <div class="stat-label">Today's Revenue</div>
          <div class="stat-value">‚Ç±{{ today_revenue|default:'0.00' }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">This Week</div>
          <div class="stat-value">‚Ç±{{ week_revenue|default:'0.00' }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">This Month</div>
          <div class="stat-value">‚Ç±{{ month_revenue|default:'0.00' }}</div>
        </div>
      </div>
    </div>

    <!-- Appointment Statistics -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold text-light-text mb-6">Appointment Statistics</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="stat-card">
          <div class="stat-label">Total Appointments</div>
          <div class="stat-value">{{ total_appointments|default:0 }}</div>
        </div>
        <div class="stat-card bg-amber-500/10 border-amber-500/20">
          <div class="stat-label text-amber-400">Pending</div>
          <div class="stat-value text-amber-400">{{ pending_appointments|default:0 }}</div>
        </div>
        <div class="stat-card bg-primary-500/10 border-primary-500/20">
          <div class="stat-label text-primary-600">Confirmed</div>
          <div class="stat-value text-primary-600">{{ confirmed_appointments|default:0 }}</div>
        </div>
        <div class="stat-card bg-emerald-500/10 border-emerald-500/20">
          <div class="stat-label text-emerald-400">Completed</div>
          <div class="stat-value text-emerald-400">{{ completed_appointments|default:0 }}</div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-8">
        <!-- Top Services -->
        <div class="card p-6">
          <h2 class="text-2xl font-bold text-light-text mb-6">Top Services</h2>
          {% if top_services %}
            <div class="space-y-4">
              {% for service in top_services %}
                <div class="flex items-center justify-between p-4 bg-light-elevated rounded-xl border border-light-border hover:border-primary-500/50 transition-all">
                  <div class="flex-1">
                    <h4 class="font-semibold text-light-text mb-1">{{ service.name }}</h4>
                    <p class="text-sm text-light-muted">{{ service.booking_count }} booking{{ service.booking_count|pluralize }}</p>
                  </div>
                  <div class="text-gradient font-bold text-xl">‚Ç±{{ service.total_revenue|floatformat:2 }}</div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-light-muted text-center py-8">No service data available</p>
          {% endif %}
        </div>

        <!-- Payment Methods -->
        <div class="card p-6">
          <h2 class="text-2xl font-bold text-light-text mb-6">Payment Methods</h2>
          {% if payment_methods %}
            <div class="space-y-3">
              {% for method in payment_methods %}
                <div class="flex items-center justify-between p-4 bg-light-elevated rounded-lg border border-light-border">
                  <div class="flex items-center gap-3">
                    <span class="font-semibold text-light-text">{{ method.method_display }}</span>
                    <span class="badge badge-info">{{ method.count }} payment{{ method.count|pluralize }}</span>
                  </div>
                  <span class="text-gradient font-bold text-lg">‚Ç±{{ method.total|floatformat:2 }}</span>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-light-muted text-center py-8">No payment data available</p>
          {% endif %}
        </div>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-1">
        <div class="card p-6 sticky top-24">
          <h3 class="text-xl font-bold text-light-text mb-4 flex items-center gap-2">
            <span>‚ö†Ô∏è</span>
            Low Stock Alerts
          </h3>
          {% if low_stock_alerts %}
            <div class="space-y-2 mb-4">
              {% for item in low_stock_alerts %}
                <a href="{% url 'inventory:detail' item.id %}" class="block p-3 bg-light-elevated rounded-lg border border-amber-500/20 hover:border-amber-500/50 transition-all">
                  <div class="flex items-start justify-between gap-2 mb-1">
                    <span class="text-light-text font-semibold text-sm">{{ item.name }}</span>
                    <span class="badge badge-warning text-xs">Low</span>
                  </div>
                  <span class="text-amber-400 text-sm font-bold">{{ item.stock }} {{ item.unit }}</span>
                </a>
              {% endfor %}
            </div>
            <a href="{% url 'inventory:alerts' %}" class="btn btn-primary text-sm w-full">
              View All Alerts
            </a>
          {% else %}
            <div class="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-center">
              <p class="text-sm text-emerald-400">All stock levels healthy</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Advanced Charts Section -->
    <div class="mt-16 pt-12 border-t border-light-border">
      <div class="mb-12">
        <h2 class="text-3xl font-bold text-gradient mb-2">üìä Interactive Analytics Charts</h2>
        <p class="text-light-muted">Visualize trends and patterns in your business data</p>
      </div>

      <!-- Weekly Seasonal Pattern Chart -->
      <div class="card p-8 mb-8">
        <div class="mb-6">
          <h3 class="text-2xl font-bold text-light-text mb-2">üìà Weekly Seasonal Pattern</h3>
          <p class="text-sm text-light-muted">
            7-day revenue pattern showing your daily trends for the week. The dashed line marks today.
          </p>
        </div>
        <div class="bg-light-bg p-6 rounded-lg">
          <canvas id="weeklyChart" height="80"></canvas>
        </div>
        <div class="mt-4 p-3 bg-emerald-50 border border-emerald-200 rounded text-sm text-emerald-700">
          üí° <strong>Tip:</strong> Use this pattern to anticipate demand and schedule staff accordingly.
        </div>
      </div>

      <!-- Monthly Service Demand Chart -->
      <div class="card p-8 mb-8">
        <div class="mb-6">
          <h3 class="text-2xl font-bold text-light-text mb-2">üíº Monthly Demand by Service</h3>
          <p class="text-sm text-light-muted">
            Tracks demand for each service over the last 12 months. Identify seasonal trends and popular services.
          </p>
        </div>
        <div class="bg-light-bg p-6 rounded-lg">
          <canvas id="serviceDemandChart" height="80"></canvas>
        </div>
        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-700">
          üí° <strong>Tip:</strong> Services with consistent demand are your reliable revenue drivers.
        </div>
      </div>

      <!-- Revenue vs Cancellations Chart -->
      <div class="card p-8 mb-8">
        <div class="mb-6">
          <h3 class="text-2xl font-bold text-light-text mb-2">üí∞ Revenue vs Cancellations</h3>
          <p class="text-sm text-light-muted">
            Compares monthly revenue (gold) against cancellation counts (red). Lower cancellations = higher revenue.
          </p>
        </div>
        <div class="bg-light-bg p-6 rounded-lg">
          <canvas id="revenueChart" height="80"></canvas>
        </div>
        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded text-sm text-amber-700">
          üí° <strong>Tip:</strong> Spikes in cancellations can indicate scheduling conflicts or staffing issues.
        </div>
      </div>

      <!-- Stylist Utilization Chart -->
      <div class="card p-8 mb-8">
        <div class="mb-6">
          <h3 class="text-2xl font-bold text-light-text mb-2">üë• Stylist Utilization Rates</h3>
          <p class="text-sm text-light-muted">
            Shows completion rates for top service providers over the last 30 days. Higher rates indicate productivity.
          </p>
        </div>
        <div class="bg-light-bg p-6 rounded-lg">
          <canvas id="utilizationChart" height="80"></canvas>
        </div>
        <div class="mt-4 p-3 bg-purple-50 border border-purple-200 rounded text-sm text-purple-700">
          üí° <strong>Tip:</strong> Consistently high utilization indicates a healthy, productive team.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Global Chart Configuration
Chart.defaults.font.family = "'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI'";
Chart.defaults.color = '#8b8b8b';

// Colors
const colors = {
  primary: '#d4af37',
  accent: '#1a1a1a',
  success: '#10b981',
  danger: '#ef4444',
  warning: '#f59e0b',
  info: '#3b82f6'
};

// Weekly Seasonal Pattern Chart
fetch('{% url "analytics:api_weekly_seasonal" %}')
  .then(response => response.json())
  .then(data => {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.dates,
        datasets: [{
          label: 'Daily Revenue',
          data: data.values,
          borderColor: colors.primary,
          backgroundColor: 'rgba(212, 175, 55, 0.05)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 6,
          pointBackgroundColor: colors.primary,
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverRadius: 8,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: false }},
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0, 0, 0, 0.05)' },
            ticks: { callback: function(value) { return '‚Ç±' + value.toLocaleString(); }}
          },
          x: { grid: { display: false }}
        }
      }
    });
  });

// Monthly Service Demand Chart
fetch('{% url "analytics:api_monthly_demand" %}')
  .then(response => response.json())
  .then(data => {
    const ctx = document.getElementById('serviceDemandChart').getContext('2d');
    const datasets = data.services.map((service, idx) => ({
      label: service.name,
      data: service.monthlyData,
      borderColor: service.color,
      backgroundColor: 'transparent',
      borderWidth: 2.5,
      tension: 0.4,
      pointRadius: 4,
      pointBackgroundColor: service.color,
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    }));

    new Chart(ctx, {
      type: 'line',
      data: { labels: data.months, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { position: 'top', labels: { padding: 20 }}},
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0, 0, 0, 0.05)' },
            ticks: { callback: function(value) { return value + ' bookings'; }}
          },
          x: { grid: { display: false }}
        }
      }
    });
  });

// Revenue vs Cancellations Chart
fetch('{% url "analytics:api_revenue_cancellations" %}')
  .then(response => response.json())
  .then(data => {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.months,
        datasets: [
          {
            label: 'Revenue',
            data: data.revenue,
            backgroundColor: colors.primary,
            borderColor: colors.primary,
            borderWidth: 1,
            borderRadius: 4
          },
          {
            label: 'Cancellations',
            data: data.cancellations,
            backgroundColor: colors.danger,
            borderColor: colors.danger,
            borderWidth: 1,
            borderRadius: 4,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { position: 'top', labels: { padding: 20 }}},
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            grid: { color: 'rgba(0, 0, 0, 0.05)' },
            ticks: { callback: function(value) { return '‚Ç±' + value.toLocaleString(); }}
          },
          y1: {
            type: 'linear',
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: { callback: function(value) { return value + ' cancellations'; }}
          },
          x: { grid: { display: false }}
        }
      }
    });
  });

// Stylist Utilization Chart
fetch('{% url "analytics:api_stylist_utilization" %}')
  .then(response => response.json())
  .then(data => {
    const ctx = document.getElementById('utilizationChart').getContext('2d');
    new Chart(ctx, {
      type: 'barH',
      type: 'bar',
      data: {
        labels: data.stylists,
        datasets: [{
          label: 'Utilization Rate (%)',
          data: data.utilization,
          backgroundColor: colors.primary,
          borderColor: colors.primary,
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: false }},
        scales: {
          x: {
            beginAtZero: true,
            max: 100,
            grid: { color: 'rgba(0, 0, 0, 0.05)' },
            ticks: { callback: function(value) { return value + '%'; }}
          },
          y: { grid: { display: false }}
        }
      }
    });
  });
</script>

{% endblock content %}
