{% extends 'base.html' %}
{% load static %}

{% block title %}Chat Assistant Â· Dreambook Salon{% endblock title %}

{% block extra_head %}
<style>
  .page-chatbot {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
  }

  .page-chatbot__header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .page-chatbot__container {
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    background: #fff;
  }

  .page-chatbot__messages {
    height: 500px;
    overflow-y: auto;
    padding: 1.5rem;
    background: #f8f9fa;
  }

  .page-chatbot__message {
    margin-bottom: 1rem;
    display: flex;
    align-items: flex-start;
  }

  .page-chatbot__message--user {
    justify-content: flex-end;
  }

  .page-chatbot__message-content {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    word-wrap: break-word;
  }

  .page-chatbot__message--bot .page-chatbot__message-content {
    background: #e9ecef;
    color: #212529;
  }

  .page-chatbot__message--user .page-chatbot__message-content {
    background: #007bff;
    color: #fff;
  }

  .page-chatbot__message-label {
    font-size: 0.75rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
    color: #6c757d;
  }

  .page-chatbot__input-area {
    padding: 1rem;
    background: #fff;
    border-top: 1px solid #ddd;
  }

  .page-chatbot__input-form {
    display: flex;
    gap: 0.5rem;
  }

  .page-chatbot__input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }

  .page-chatbot__send-btn {
    padding: 0.75rem 1.5rem;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
  }

  .page-chatbot__send-btn:hover {
    background: #0056b3;
  }

  .page-chatbot__send-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
  }

  .page-chatbot__welcome {
    text-align: center;
    color: #6c757d;
    padding: 2rem;
  }
</style>
{% endblock extra_head %}

{% block content %}
  <section class="page-chatbot">
    <header class="page-chatbot__header">
      <h1>Chat Assistant</h1>
      <p>Ask me anything about Dreambook Salon services, appointments, or general inquiries</p>
    </header>

    <div class="page-chatbot__container">
      <div id="chatMessages" class="page-chatbot__messages">
        <div class="page-chatbot__welcome">
          <p>Welcome! How can I help you today?</p>
          <p><small>Try asking about services, booking, or anything else!</small></p>
        </div>
      </div>

      <div class="page-chatbot__input-area">
        <form id="chatForm" class="page-chatbot__input-form">
          {% csrf_token %}
          <input
            type="text"
            id="chatInput"
            class="page-chatbot__input"
            placeholder="Type your message here..."
            required
            autocomplete="off"
          >
          <button type="submit" id="sendBtn" class="page-chatbot__send-btn">Send</button>
        </form>
      </div>
    </div>
  </section>
{% endblock content %}

{% block extra_scripts %}
<script>
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const chatMessages = document.getElementById('chatMessages');
  const sendBtn = document.getElementById('sendBtn');
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Clear welcome message on first interaction
  let firstMessage = true;

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const message = chatInput.value.trim();
    if (!message) return;

    // Clear welcome message on first message
    if (firstMessage) {
      chatMessages.innerHTML = '';
      firstMessage = false;
    }

    // Add user message to chat
    addMessage(message, 'user');
    chatInput.value = '';

    // Disable input while waiting for response
    chatInput.disabled = true;
    sendBtn.disabled = true;

    try {
      // Send message to API
      const response = await fetch('/api/chatbot/respond/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ message: message })
      });

      const data = await response.json();

      if (data.error) {
        addMessage('Sorry, I encountered an error. Please try again.', 'bot');
      } else {
        addMessage(data.response, 'bot');
      }
    } catch (error) {
      console.error('Error:', error);
      addMessage('Sorry, I could not connect to the server. Please try again later.', 'bot');
    } finally {
      // Re-enable input
      chatInput.disabled = false;
      sendBtn.disabled = false;
      chatInput.focus();
    }
  });

  function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `page-chatbot__message page-chatbot__message--${sender}`;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'page-chatbot__message-content';
    contentDiv.textContent = text;

    messageDiv.appendChild(contentDiv);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Focus input on load
  chatInput.focus();
</script>
{% endblock extra_scripts %}
