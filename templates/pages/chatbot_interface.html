{% extends 'base.html' %}
{% load static %}

{% block title %}Chat Assistant Â· Dreambook Salon{% endblock title %}

{% block content %}
  <div class="container-custom py-12">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gradient mb-2">Chat Assistant</h1>
        <p class="text-light-muted">Ask me anything about Dreambook Salon services, appointments, or general inquiries</p>
      </div>

      <!-- Chat Container -->
      <div class="card overflow-hidden">
        <!-- Messages Area -->
        <div id="chatMessages" class="h-[500px] overflow-y-auto p-6 bg-light-bg">
          <div class="text-center py-12">
            <div class="w-16 h-16 bg-gradient-to-br from-primary-500 to-accent-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-primary-500/30 animate-pulse-slow">
              <span class="text-white text-3xl">ðŸ¤–</span>
            </div>
            <h3 class="text-light-text font-bold text-xl mb-2">AI Assistant</h3>
            <p class="text-light-muted text-sm mb-4">I can help you with real-time information!</p>
            {% if user.is_authenticated and user.role in 'ADMIN,STAFF' %}
              <div class="inline-block bg-primary-500/10 border border-primary-500/20 rounded-lg px-4 py-2 text-left">
                <p class="text-primary-600 text-sm font-semibold mb-1">ðŸ“Š Staff Mode Active</p>
                <p class="text-light-muted text-xs">Ask about revenue, analytics, inventory, or stats!</p>
              </div>
            {% else %}
              <div class="inline-block bg-accent-500/10 border border-accent-500/20 rounded-lg px-4 py-2 text-left">
                <p class="text-accent-600 text-sm font-semibold mb-1">ðŸ’‡ Customer Mode</p>
                <p class="text-light-muted text-xs">Ask about services, pricing, popular treatments!</p>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-light-surface border-t border-light-border">
          <form id="chatForm" class="flex gap-3">
            {% csrf_token %}
            <input
              type="text"
              id="chatInput"
              class="input flex-1"
              placeholder="Type your message here..."
              required
              autocomplete="off"
            >
            <button type="submit" id="sendBtn" class="btn btn-primary px-6">
              Send
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}

{% block extra_scripts %}
<script>
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const chatMessages = document.getElementById('chatMessages');
  const sendBtn = document.getElementById('sendBtn');
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Clear welcome message on first interaction
  let firstMessage = true;

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const message = chatInput.value.trim();
    if (!message) return;

    // Clear welcome message on first message
    if (firstMessage) {
      chatMessages.innerHTML = '';
      firstMessage = false;
    }

    // Add user message to chat
    addMessage(message, 'user');
    chatInput.value = '';

    // Disable input while waiting for response
    chatInput.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
      // Send message to API
      const response = await fetch('/api/chatbot/respond/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ message: message })
      });

      const data = await response.json();

      if (data.error) {
        addMessage('Sorry, I encountered an error. Please try again.', 'bot');
      } else {
        addMessage(data.response, 'bot');
      }
    } catch (error) {
      console.error('Error:', error);
      addMessage('Sorry, I could not connect to the server. Please try again later.', 'bot');
    } finally {
      // Re-enable input
      chatInput.disabled = false;
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
      chatInput.focus();
    }
  });

  function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

    const contentDiv = document.createElement('div');
    contentDiv.className = `max-w-[70%] px-4 py-3 rounded-xl whitespace-pre-wrap ${
      sender === 'user'
        ? 'bg-gradient-to-r from-primary-600 to-primary-500 text-white'
        : 'bg-light-elevated border border-light-border text-light-text'
    }`;

    // Format text: convert **bold** to <strong>, preserve newlines
    let formattedText = text
      .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-primary-600">$1</strong>')
      .replace(/\n/g, '<br>');

    contentDiv.innerHTML = formattedText;

    messageDiv.appendChild(contentDiv);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom smoothly
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Focus input on load
  chatInput.focus();
</script>
{% endblock extra_scripts %}
