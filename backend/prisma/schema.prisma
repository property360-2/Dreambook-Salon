generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id               String          @id @default(cuid())
  email            String          @unique
  name             String
  passwordHash     String
  role             String          @default("CUSTOMER")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  appointments     Appointment[]   @relation("CustomerAppointments")
  createdServices  Service[]       @relation("ServiceCreatedBy")
  blockedRanges    BlockedRange[]  @relation("BlockedRangeCreatedBy")
  chatbotRules     ChatbotRule[]   @relation("ChatbotRuleCreatedBy")
  appointmentEvents AppointmentEvent[] @relation("AppointmentEventCreatedBy")
  inventoryAdjustments InventoryAdjustment[] @relation("InventoryAdjustmentCreatedBy")
}

model Service {
  id              String             @id @default(cuid())
  name            String
  description     String?
  durationMinutes Int
  priceCents      Int
  imageUrl        String?
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  appointments    Appointment[]
  createdBy       User?              @relation("ServiceCreatedBy", fields: [createdById], references: [id])
  createdById     String?
  inventoryLinks  ServiceInventory[]
}

model Appointment {
  id               String            @id @default(cuid())
  status           String            @default("PENDING")
  scheduledStart   DateTime
  scheduledEnd     DateTime
  notes            String?
  confirmationCode String            @default(cuid()) @unique
  customerName     String            @default("")
  customerEmail    String            @default("")
  customerPhone    String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  customer         User?             @relation("CustomerAppointments", fields: [customerId], references: [id])
  customerId       String?
  service          Service           @relation(fields: [serviceId], references: [id])
  serviceId        String
  payment          Payment?
  events           AppointmentEvent[]
  inventoryAdjustments InventoryAdjustment[]
}

model Inventory {
  id            String             @id @default(cuid())
  name          String
  description   String?
  stock         Int                @default(0)
  unit          String?
  threshold     Int                @default(0)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  serviceLinks  ServiceInventory[]
  adjustments   InventoryAdjustment[]
}

model ServiceInventory {
  id          String    @id @default(cuid())
  quantity    Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  service     Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceId   String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  inventoryId String

  @@unique([serviceId, inventoryId])
}

model Settings {
  id                       String         @id @default("singleton")
  maxConcurrentAppointments Int            @default(1)
  bookingWindowDays        Int            @default(30)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  blockedRanges            BlockedRange[]
}

model BlockedRange {
  id          String    @id @default(cuid())
  startsAt    DateTime
  endsAt      DateTime
  reason      String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  settingsId  String    @default("singleton")
  settings    Settings  @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  createdById String?
  createdBy   User?     @relation("BlockedRangeCreatedBy", fields: [createdById], references: [id])

  @@index([startsAt, endsAt])
}

model Payment {
  id             String      @id @default(cuid())
  method         String
  status         String      @default("PENDING")
  amountCents    Int
  transactionId  String?
  appointmentId  String      @unique
  appointment    Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model ChatbotRule {
  id          String    @id @default(cuid())
  pattern     String
  reply       String
  priority    Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String?
  createdBy   User?     @relation("ChatbotRuleCreatedBy", fields: [createdById], references: [id])

  @@index([priority])
}

model AppointmentEvent {
  id            String      @id @default(cuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  status        String
  notes         String?
  createdAt     DateTime    @default(now())
  createdById   String?
  createdBy     User?       @relation("AppointmentEventCreatedBy", fields: [createdById], references: [id])
}

model InventoryAdjustment {
  id             String       @id @default(cuid())
  inventoryId    String
  inventory      Inventory    @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  appointmentId  String?
  appointment    Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  change         Int
  reason         String
  createdAt      DateTime     @default(now())
  createdById    String?
  createdBy      User?        @relation("InventoryAdjustmentCreatedBy", fields: [createdById], references: [id])

  @@index([createdAt])
}
